<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ê²Œì‹œíŒ</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #f5f5f5;
        padding: 20px;
        font-family: Arial, sans-serif;
      }
      canvas {
        border: 2px solid #333;
        background-color: #fff;
        cursor: crosshair;
      }
      .controls,
      .guestbook {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
      }
      button,
      textarea,
      #guestbookList img {
        max-width: 200px;
        display: block;
        margin-bottom: 5px;
      }
      .replies {
        max-height: 100px;
        overflow-y: auto;
        background: #fff;
        margin-top: 10px;
        padding: 5px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h2>ê²Œì‹œíŒ</h2>
    <div class="guestbook">
      <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" />
      <button onclick="setUser()">ë¡œê·¸ì¸</button>
    </div>
    <p id="currentUser"></p>

    <div class="controls">
      <label
        >ì„  ìƒ‰ìƒ: <input type="color" id="colorPicker" value="#000000"
      /></label>
      <label
        >ì„  ë‘ê»˜: <input type="range" id="lineWidth" min="1" max="20" value="3"
      /></label>
      <button id="eraserBtn">ì§€ìš°ê°œ</button>
      <button id="clearBtn">ì „ì²´ ì§€ìš°ê¸°</button>
    </div>
    <div>
      <canvas id="canvas" width="300" height="300"></canvas>
    </div>

    <div class="guestbook">
      <textarea
        id="message"
        placeholder="ë°©ëª…ë¡ ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”"
        rows="4"
        cols="50"
      ></textarea>
      <button id="saveBtn">ì €ì¥</button>
    </div>

    <h3>ğŸ“œ ë°©ëª…ë¡ ëª©ë¡</h3>
    <div id="guestbookList"></div>

    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const colorPicker = document.getElementById("colorPicker");
      const lineWidth = document.getElementById("lineWidth");
      const eraserBtn = document.getElementById("eraserBtn");
      const clearBtn = document.getElementById("clearBtn");
      const message = document.getElementById("message");
      const saveBtn = document.getElementById("saveBtn");
      const guestbookList = document.getElementById("guestbookList");
      const currentUserEl = document.getElementById("currentUser");
      const nicknameInput = document.getElementById("nickname");

      let painting = false;
      let erasing = false;

      function setUser() {
        const nickname = nicknameInput.value.trim();
        if (!nickname) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        const userId = crypto.randomUUID();
        localStorage.setItem(
          "currentUser",
          JSON.stringify({ userId, nickname })
        );
        currentUserEl.textContent = `í˜„ì¬ ì‚¬ìš©ì: ${nickname}`;
      }

      function getCurrentUser() {
        return JSON.parse(localStorage.getItem("currentUser"));
      }

      function startPosition(e) {
        painting = true;
        draw(e);
      }
      function endPosition() {
        painting = false;
        ctx.beginPath();
      }

      function draw(e) {
        if (!painting) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineWidth = lineWidth.value;
        ctx.lineCap = "round";
        ctx.strokeStyle = erasing ? "#ffffff" : colorPicker.value;
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
      }

      canvas.addEventListener("mousedown", startPosition);
      canvas.addEventListener("mouseup", endPosition);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseleave", endPosition);

      eraserBtn.addEventListener("click", () => {
        erasing = !erasing;
        eraserBtn.textContent = erasing ? "ê·¸ë¦¬ê¸°" : "ì§€ìš°ê°œ";
      });

      clearBtn.addEventListener("click", () =>
        ctx.clearRect(0, 0, canvas.width, canvas.height)
      );

      saveBtn.addEventListener("click", () => {
        const user = getCurrentUser();
        if (!user) return alert("ë¡œê·¸ì¸ í›„ ì €ì¥í•˜ì„¸ìš”.");
        const imgData = canvas.toDataURL();
        const text = message.value.trim();
        if (!text) return alert("ê¸€ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.");

        const entry = {
          id: crypto.randomUUID(),
          userId: user.userId,
          nickname: user.nickname,
          image: imgData,
          text,
          timestamp: new Date().toLocaleString(),
        };
        const guestbook = JSON.parse(localStorage.getItem("guestbook") || "[]");
        guestbook.unshift(entry);
        localStorage.setItem("guestbook", JSON.stringify(guestbook));
        renderGuestbook();
        message.value = "";
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });

      function deleteEntry(entryId) {
        const user = getCurrentUser();
        const guestbook = JSON.parse(localStorage.getItem("guestbook") || "[]");
        const target = guestbook.find((g) => g.id === entryId);
        if (!target || target.userId !== user?.userId)
          return alert("ë³¸ì¸ ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const newGuestbook = guestbook.filter((g) => g.id !== entryId);
        localStorage.setItem("guestbook", JSON.stringify(newGuestbook));
        renderGuestbook();
      }

      function addOrEditComment(entryId) {
        const user = getCurrentUser();
        if (!user) return alert("ë¡œê·¸ì¸ í›„ ì‘ì„±í•˜ì„¸ìš”.");
        const guestbook = JSON.parse(localStorage.getItem("guestbook") || "[]");
        const target = guestbook.find((g) => g.id === entryId);
        let text = prompt(
          target.comment ? "ëŒ“ê¸€ ìˆ˜ì •í•˜ê¸°" : "ëŒ“ê¸€ ì‘ì„±í•˜ê¸°",
          target.comment?.text || ""
        );
        if (text === null || text.trim() === "") return;
        target.comment = {
          userId: user.userId,
          nickname: user.nickname,
          text,
          timestamp: new Date().toLocaleString(),
          replies: target.comment?.replies || [],
        };
        localStorage.setItem("guestbook", JSON.stringify(guestbook));
        renderGuestbook();
      }

      function deleteComment(entryId) {
        const user = getCurrentUser();
        const guestbook = JSON.parse(localStorage.getItem("guestbook") || "[]");
        const target = guestbook.find((g) => g.id === entryId);
        if (!target?.comment || target.comment.userId !== user?.userId)
          return alert("ë³¸ì¸ ëŒ“ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        delete target.comment;
        localStorage.setItem("guestbook", JSON.stringify(guestbook));
        renderGuestbook();
      }

      function addReply(entryId) {
        const user = getCurrentUser();
        if (!user) return alert("ë¡œê·¸ì¸ í›„ ì‘ì„±í•˜ì„¸ìš”.");
        const guestbook = JSON.parse(localStorage.getItem("guestbook") || "[]");
        const target = guestbook.find((g) => g.id === entryId);
        if (!target?.comment)
          return alert("ëŒ“ê¸€ì´ ìˆì–´ì•¼ ëŒ€ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        if (user.userId !== target.userId)
          return alert("ê¸€ ì‘ì„±ìë§Œ ëŒ€ëŒ“ê¸€ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.");

        const replyText = prompt("ëŒ€ëŒ“ê¸€ ì‘ì„±í•˜ê¸°");
        if (!replyText) return;
        target.comment.replies.push({
          userId: user.userId,
          nickname: user.nickname,
          text: replyText,
          timestamp: new Date().toLocaleString(),
        });
        localStorage.setItem("guestbook", JSON.stringify(guestbook));
        renderGuestbook();
      }

      function deleteReply(entryId, replyIdx) {
        const user = getCurrentUser();
        const guestbook = JSON.parse(localStorage.getItem("guestbook") || "[]");
        const target = guestbook.find((g) => g.id === entryId);
        const reply = target?.comment?.replies[replyIdx];
        if (!reply || reply.userId !== user?.userId)
          return alert("ë³¸ì¸ ëŒ€ëŒ“ê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        if (!confirm("ëŒ€ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        target.comment.replies.splice(replyIdx, 1);
        localStorage.setItem("guestbook", JSON.stringify(guestbook));
        renderGuestbook();
      }

      function renderGuestbook() {
        const guestbook = JSON.parse(localStorage.getItem("guestbook") || "[]");
        const user = getCurrentUser();
        guestbookList.innerHTML = guestbook
          .map(
            (entry) => `
        <div style="background:#fff; padding:10px; margin-bottom:10px; border-radius:8px;">
          <div>
          <img src="${entry.image}" alt="ê·¸ë¦¼" >
          </div>
          <div>
          <p>${entry.text}</p>
          <small>ì‘ì„±ì: ${entry.nickname} (${entry.timestamp})</small><br>
          ${
            user?.userId === entry.userId
              ? `<button onclick="deleteEntry('${entry.id}')">ì‚­ì œ</button>`
              : ""
          }
          <div style="margin-top:10px; padding:10px; background:#f0f0f0; border-radius:6px;">
            ${
              entry.comment
                ? `
              <p><strong>${entry.comment.nickname}:</strong> ${
                    entry.comment.text
                  }</p>
              <small>${entry.comment.timestamp}</small><br>
              ${
                user?.userId === entry.comment.userId
                  ? `<button onclick="addOrEditComment('${entry.id}')">ëŒ“ê¸€ ìˆ˜ì •</button>
              <button onclick="deleteComment('${entry.id}')">ëŒ“ê¸€ ì‚­ì œ</button>`
                  : ""
              }
              <button onclick="addReply('${entry.id}')">ëŒ€ëŒ“ê¸€ ë‹¬ê¸°</button>
              <div class="replies">
                ${entry.comment.replies
                  ?.map(
                    (reply, idx) => `
                  <div style="border-bottom:1px solid #ddd; padding:5px 0;">
                    <strong>${reply.nickname}:</strong> ${reply.text} <small>${
                      reply.timestamp
                    }</small>
                    ${
                      user?.userId === reply.userId
                        ? `<button onclick="deleteReply('${entry.id}', ${idx})">ì‚­ì œ</button>`
                        : ""
                    }
                  </div>
                `
                  )
                  .join("")}
              </div>
            `
                : `<button onclick="addOrEditComment('${entry.id}')">ëŒ“ê¸€ ë‹¬ê¸°</button>`
            }
          </div>
        </div>
      `
          )
          .join("");
      }

      renderGuestbook();
    </script>
  </body>
</html>
