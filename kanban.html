<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Ïπ∏Î∞ò Î≥¥Îìú</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }
      html::-webkit-scrollbar {
        display: none; /* for Chrome, Safari, and Opera */
      }
      body {
        margin: 0;
        background: #f4f6fa;
        padding: 20px;
        overflow-x: auto;
      }
      .board {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        scrollbar-width: none;
        min-width: max-content;
        margin-top: 60px;
      }
      #board-title {
        position: fixed; /* Í≥†Ï†ï */
        top: 0;
        left: 0;
        width: 100%;
        height: 60px;
        line-height: 60px; /* ÏÑ∏Î°ú Ï†ïÎ†¨ */
        background: #f4f6fa;
        z-index: 100;
        text-align: center;
        font-size: 24px;
        color: #2f3640;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* ÏÇ¥Ïßù Í∑∏Î¶ºÏûê */
        margin: 0;
      }
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: fit-content; /* ‚úÖ Ïó¨Í∏∞Îßå ÏàòÏ†ï! */
      }

      .column {
        position: relative;
        z-index: 0;
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        width: 280px;
        flex-shrink: 0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }

      .column h2 {
        font-size: 18px;
        margin-bottom: 10px;
      }
      .card-title-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        outline: none;
      }
      .card-title-input:focus {
        border-color: #4b7bec;
      }

      .member-select {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background-color: #fff;
        font-size: 13px;
        margin-top: 8px;
      }

      .save-card-btn {
        margin-top: 12px;
        padding: 8px 14px;
        background-color: #4cd137;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        float: right;
        transition: background 0.2s;
      }
      .save-card-btn:hover {
        background-color: #44bd32;
      }
      .member-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 12px;
        padding-left: 0;
        list-style: none;
      }

      .member-list li {
        margin-right: 6px;
        cursor: pointer;
        position: relative;
        padding-left: 20px;
      }

      .member-list li::before {
        content: "üë• ";
        position: absolute;
        left: 0;
      }
      .member-list li:hover {
        background-color: #ffdede;
        color: #c0392b;
        text-decoration: line-through;
      }
      .card-members::before,
      .modal-members::before {
        content: "üë• ";
      }

      .card-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 10px;
        min-height: 30px; /* üëà Ïù¥Í≤ÉÎßå ÏûàÏúºÎ©¥ Îπà Ïª¨ÎüºÎèÑ ÎìúÎ°≠ Í∞ÄÎä•Ìï¥Ïßê */
      }
      .card {
        background: #fafafa;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        z-index: 1;
      }
      .card.dragging {
        opacity: 0.5;
      }
      .add-card-btn,
      .add-column-btn {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
      }
      .delete-column,
      .edit-column {
        display: none;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
        padding: 3px;
        margin-top: 6px;
        float: right;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        background: #ffdddd;
      }
      .delete-column {
        padding-inline: 6px;
      }
      .col-header:hover .delete-column,
      .col-header:hover .edit-column {
        display: inline-block;
      }

      .column .edit-column {
        right: 36px;
        background: #e0f7ff;
      }
      .add-card-btn,
      .add-column-btn {
        background-color: #eef1f5;
        color: #333;
      }
      .add-card-btn:hover,
      .add-column-btn:hover {
        background-color: #d6e4f0;
      }
      .column-header {
        position: relative;
        padding-bottom: 10px;
      }

      .card .delete-btn,
      .card .edit-btn {
        display: none;
        position: absolute;
        top: 6px;
        right: 6px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        padding: 3px;
        background: #ffdddd;
      }
      .card .delete-btn {
        padding-inline: 6px;
      }

      .card .edit-btn {
        right: 30px;
        background: #e0f7ff;
      }

      .card:hover .delete-btn,
      .card:hover .edit-btn {
        display: inline-block;
      }
      /* Î™®Îã¨ Í∏∞Î≥∏ Ïä§ÌÉÄÏùº */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background: #fff;
        width: 500px;
        max-width: 90%;
        margin: 80px auto;
        padding: 15px;
        border-radius: 12px;
        position: relative;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 4px;
      }

      .close-btn {
        font-size: 20px;
        cursor: pointer;
        background: none;
        border: none;
        color: #999;
        transition: color 0.2s ease;
        padding: 4px 8px;
      }

      .close-btn:hover {
        color: #333;
      }

      .modal-title {
        width: 100%;
        font-size: 18px;
        padding: 8px;
        margin-bottom: 10px;
      }
      .modal-title[contenteditable="true"] {
        border: 1px solid #4b7bec;
        border-radius: 6px;
        padding: 8px;
        outline: none;
      }

      .modal-members {
        font-size: 14px;
        color: #444;
        margin-left: 10px;
        margin-bottom: 12px;
      }

      .modal-editor {
        min-height: 200px;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.5;
      }
      .edit-save-btn {
        background-color: #eef1f5;
        margin-top: 12px;
        padding: 8px 14px;
        color: black;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        float: right;
        transition: background 0.2s;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="board-title" contenteditable="false">üìå Ïπ∏Î∞ò ÌîÑÎ°úÏ†ùÌä∏ Î≥¥Îìú üìå</h1>
      <div class="board">
        <div class="column">
          <button class="add-column-btn">+ Ïª¨Îüº Ï∂îÍ∞Ä</button>
        </div>
      </div>
    </div>
    <!-- ÏÉÅÏÑ∏ Î™®Îã¨ -->
    <div id="detailModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <button class="close-btn">&times;</button>
        </div>
        <div class="modal-title" contenteditable="false">Ï†úÎ™© ÏûÖÎ†•</div>
        <div class="modal-members"></div>
        <div class="modal-editor" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></div>
        <div style="margin-top: 10px; display: flex; justify-content: flex-end">
          <button id="toggleEdit" class="edit-save-btn">‚úèÔ∏è Ìé∏Ïßë</button>
        </div>
      </div>
    </div>

    <script>
      let draggedCard = null;
      let draggedColumn = null;
      let hoveredCard = null;
      let hoveredColumn = null;
      let currentEditingCard = null;

      const boardTitle = document.getElementById("board-title");

      // ÌÅ¥Î¶≠ÌïòÎ©¥ Ìé∏Ïßë Í∞ÄÎä•ÌïòÍ≤å
      boardTitle.addEventListener("click", () => {
        boardTitle.setAttribute("contenteditable", "true");
        boardTitle.focus();
      });

      // Ìè¨Ïª§Ïä§ Î≤óÏñ¥ÎÇòÎ©¥ Ï†ÄÏû• + Ìé∏Ïßë Î∂àÍ∞ÄÌïòÍ≤å
      boardTitle.addEventListener("blur", () => {
        boardTitle.setAttribute("contenteditable", "false");
        const title = boardTitle.textContent.trim() || "üìå Ïπ∏Î∞ò ÌîÑÎ°úÏ†ùÌä∏ Î≥¥Îìú";
        boardTitle.textContent = title; // ÎπÑÏñ¥ÏûàÏúºÎ©¥ Í∏∞Î≥∏Í∞í

        // ÌïÑÏöîÌïòÎ©¥ localStorageÏóê Ï†ÄÏû•
        localStorage.setItem("kanbanTitle", title);
      });

      // ÌéòÏù¥ÏßÄ Î°úÎìúÏãú Ï†ÄÏû•Îêú Ï†úÎ™© Î∂àÎü¨Ïò§Í∏∞
      window.addEventListener("DOMContentLoaded", () => {
        const savedTitle = localStorage.getItem("kanbanTitle");
        if (savedTitle) {
          boardTitle.textContent = savedTitle;
        }
      });

      // Ïπ¥Îìú ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
      function makeCardDraggable(card) {
        card.addEventListener("dragstart", () => {
          draggedCard = card;
          card.classList.add("dragging");
        });

        card.addEventListener("dragend", () => {
          card.classList.remove("dragging");
          hoveredCard = null;
          draggedCard = null;
        });
        card.addEventListener("dragenter", () => {
          hoveredCard = card;
        });
      }

      // Ïª¨Îüº ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
      function makeColDraggable(column) {
        column.addEventListener("dragstart", (e) => {
          if (e.target.closest(".card")) return;

          draggedColumn = column; // ‚úÖ Ïù¥Í≤å Íº≠ ÏûàÏñ¥Ïïº dropÏóêÏÑú ÏûëÎèôÌï®
          column.style.opacity = "0.5";

          const img = new Image();
          img.src = "";
          e.dataTransfer.setDragImage(img, 0, 0);
        });

        column.addEventListener("dragend", () => {
          column.style.opacity = "1";
          draggedColumn = null;
        });
      }

      // ÏÇ≠Ï†ú Î≤ÑÌäº ÏÑ§Ï†ï
      function setupDeleteButton(card) {
        const deleteBtn = card.querySelector(".delete-btn");
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (confirm("Ïπ¥ÎìúÎ•º ÏÇ≠Ï†úÌï©ÎãàÎã§.")) {
            card.remove();
            saveBoardToStorage(); // ÏÇ≠Ï†ú ÌõÑ Ï†ÄÏû•
          }
        });
      }

      function setupEditColumn(column) {
        const editBtn = column.querySelector(".edit-column");
        const titleElem = column.querySelector("h2");

        editBtn.addEventListener("click", () => {
          const currentTitle = titleElem.textContent.trim();
          const input = document.createElement("input");
          input.type = "text";
          input.value = currentTitle;
          input.style.fontSize = "18px";
          input.style.width = "100%";
          input.style.marginBottom = "6px";
          input.style.marginTop = "25px";

          titleElem.replaceWith(input);
          input.focus();

          input.addEventListener("blur", () => {
            const newTitle = input.value.trim() || "üÜï ÏÉà Ïª¨Îüº";
            const newTitleElem = document.createElement("h2");
            newTitleElem.textContent = newTitle;
            input.replaceWith(newTitleElem);
            setupEditColumn(column);

            saveBoardToStorage(); // ‚úÖ Ï†úÎ™© Î≥ÄÍ≤Ω ÌõÑ Ï†ÄÏû• Ï∂îÍ∞Ä
          });

          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") input.blur();
          });
        });
      }

      // ÏÇ≠Ï†ú Ïª¨Îüº ÏÑ§Ï†ï
      function setupDeleteColumn(column) {
        const deleteBtn = column.querySelector(".delete-column");
        deleteBtn.addEventListener("click", () => {
          if (window.confirm("Ïª¨ÎüºÎ•º ÏÇ≠Ï†úÌï©ÎãàÎã§.")) {
            column.remove();
            saveBoardToStorage(); // ‚úÖ ÏÇ≠Ï†ú ÌõÑ Ï†ÄÏû•!
          }
        });
      }

      // Ïπ¥Îìú ÏÉùÏÑ± Ìï®Ïàò
      function createCard(
        cardData = {
          title: "üÜï ÏÉà Ïπ¥Îìú",
          id: Date.now().toString(),
          members: "",
          detail: "",
        }
      ) {
        const card = document.createElement("div");
        card.className = "card";
        card.draggable = true;
        card.style.position = "relative"; // Î≤ÑÌäº ÏúÑÏπò ÏúÑÌï¥ ÌïÑÏöî
        card.dataset.id = cardData.id;
        card.dataset.detail = cardData.detail;

        card.innerHTML = `
    <h3>${cardData.title}</h3>
      <div class = "card-members" style="font-size: 12px; color: #555; margin-top: 4px;">
         ${cardData.members}
      </div>
      <button class="edit-btn">‚úèÔ∏è</button>
      <button class="delete-btn">X</button>
  `;

        makeCardDraggable(card);
        setupDeleteButton(card);
        setupEditButton(card);
        return card;
      }
      function switchToEditMode(card) {
        if (currentEditingCard && currentEditingCard !== card) {
          const prevCard = currentEditingCard;
          const titleInput = prevCard.querySelector(".card-title-input");
          const selectedList = prevCard.querySelectorAll(".member-list li");
          currentEditingCard = card;
          if (titleInput) {
            const title = titleInput.value.trim() || "üÜï ÏÉà Ïπ¥Îìú";
            const members = Array.from(selectedList).map((li) =>
              li.textContent.trim()
            );

            prevCard.innerHTML = `
        <h3>${title}</h3>
        <div style="font-size: 12px; color: #555; margin-top: 4px;">
          ${members.join(", ")}
        </div>
        <button class="edit-btn">‚úèÔ∏è</button>
        <button class="delete-btn">X</button>
      `;
            setupDeleteButton(prevCard);
            setupEditButton(prevCard);
            makeCardDraggable(prevCard);
          }
        }

        currentEditingCard = card;
        const members = ["ÍπÄÏãúÏó∞", "Ïù¥Ïû¨ÏÑ±", "Ïù¥Ïû¨Ïõê", "Ìô©Ïú†ÏÑù"];

        const prevTitle =
          card.querySelector("h3")?.textContent.trim() || "üÜï ÏÉà Ïπ¥Îìú";
        const prevMembersText = card.querySelector("div")?.textContent || "";
        const prevMembers = prevMembersText
          .replace("üë•", "")
          .split(",")
          .map((m) => m.trim())
          .filter(Boolean);

        const selectedMembers = [...prevMembers];

        // Ïπ¥Îìú Ìé∏Ïßë UI Íµ¨ÏÑ± (liÎäî ÎπÑÏõåÎëêÍ≥† JSÎ°ú ÏÉùÏÑ±)
        card.innerHTML = `
    <div id="edit-card-box">
      <div>
        <input type="text" class="card-title-input" value="${prevTitle}" placeholder="${prevTitle}" />
      </div>
      <div style="margin-top:8px;">
        <select class="member-select">
          <option disabled selected>üë• ÌåÄÏõêÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
          ${members.map((m) => `<option value="${m}">${m}</option>`).join("")}
        </select>
      </div>
      <div class="member-list-wrapper" style="font-size: 14px; color: #555;">
        <ul class="member-list"></ul>
      </div>
      <button class="save-card-btn" style="margin-top:10px; padding:5px 10px;">‚úÖ ÌôïÏù∏</button>
    </div>
  `;

        const titleInput = card.querySelector(".card-title-input");
        const select = card.querySelector(".member-select");
        const memberList = card.querySelector(".member-list");
        const saveBtn = card.querySelector(".save-card-btn");

        // üëá ÌÅ¥Î¶≠ Ïãú ÏÇ≠Ï†ú Í∞ÄÎä•Ìïú <li> ÏÉùÏÑ±
        function setupMemberClick(li, name) {
          li.addEventListener("click", (e) => {
            e.stopPropagation(); // Ï†ÄÏû• Î∞©ÏßÄ
            selectedMembers.splice(selectedMembers.indexOf(name), 1);
            updateMemberList();
          });
        }

        function updateMemberList() {
          memberList.innerHTML = "";
          selectedMembers.forEach((name) => {
            const li = document.createElement("li");
            li.textContent = name;
            setupMemberClick(li, name);
            memberList.appendChild(li);
          });
        }

        select.addEventListener("change", () => {
          const value = select.value;
          if (!selectedMembers.includes(value)) {
            selectedMembers.push(value);
            updateMemberList();
          }
          select.selectedIndex = 0;
        });
        select.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault(); // ÏÖÄÎ†âÌä∏ Ïó¥Î¶º Î∞©ÏßÄ
            saveCard(); // Ï†ÄÏû• Ïã§Ìñâ
          }
        });

        updateMemberList(); // Ï¥àÍ∏∞ Î©§Î≤Ñ Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ

        // Ï†ÄÏû• Ï≤òÎ¶¨
        function saveCard() {
          const title = titleInput.value.trim() || prevTitle;
          const detail = card.dataset.detail || ""; // Í∏∞Ï°¥ detail Ïú†ÏßÄ
          const rawMembers = selectedMembers.join(", ");

          card.innerHTML = `
    <h3>${title}</h3>
    <div class="card-members" style="font-size: 12px; color: #555; margin-top: 4px;">
      ${rawMembers}
    </div>
    <button class="edit-btn">‚úèÔ∏è</button>
    <button class="delete-btn">X</button>
  `;

          card.dataset.detail = detail; // ‚úÖ detailÏùÄ Ïó¨Ï†ÑÌûà DOMÏóê Î≥¥Í¥Ä

          setupDeleteButton(card);
          setupEditButton(card);
          makeCardDraggable(card);
          currentEditingCard = null;
          // ‚úÖ Ïù¥Ï†úÎäî Ïó¨Í∏∞ÏÑúÎßå Ï†ÄÏû•
          saveBoardToStorage();
        }

        // ÌôïÏù∏ Î≤ÑÌäº
        saveBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          saveCard();
        });

        // Ï†úÎ™© ÏûÖÎ†• Ïãú Ï¥àÍ∏∞Ìôî
        /* let titleCleared = false;
        titleInput.addEventListener("focus", () => {
          if (!titleCleared) {
            titleInput.value = "";
            titleCleared = true;
          }
        });
*/
        titleInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault(); // Ï§ÑÎ∞îÍøà Î∞©ÏßÄ
            saveCard(); // Ï†ÄÏû• Ïã§Ìñâ
          }
        });

        // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Ï†ÄÏû•
        setTimeout(() => {
          document.addEventListener(
            "click",
            function handler(e) {
              if (!card.contains(e.target)) {
                saveCard();
                document.removeEventListener("click", handler);
              }
            },
            { once: true }
          );
        }, 0);

        titleInput.focus();
      }

      function setupEditButton(card) {
        const editBtn = card.querySelector(".edit-btn");
        editBtn.addEventListener("click", (e) => {
          e.stopPropagation(); // Ïπ¥Îìú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ
          switchToEditMode(card);
        });
      }
      // Í∞ÄÏù¥Îìú ÎùºÏù∏ ÏÉùÏÑ±Ìï®Ïàò
      function createGuideLine() {
        const guideLine = document.createElement("div");
        guideLine.className = "guide-line";
        guideLine.style.height = "10px";
        guideLine.style.background = "#cccccc";
        guideLine.style.margin = "4px 0";
        guideLine.style.borderRadius = "3px";
        return guideLine;
      }
      // Ïª¨Îüº ÏÉùÏÑ± Ìï®Ïàò
      function createColumn(title = "üÜï ÏÉà Ïª¨Îüº") {
        const column = document.createElement("div");
        const guideLine = createGuideLine();
        column.className = "column";
        column.draggable = true;
        column.innerHTML = `<div class = "col-header">
          <button class="edit-column">‚úèÔ∏è</button>
          <button class="delete-column">X</button>
            <h2>${title}</h2>
          </div>
          <div class="card-list"></div>
          <div class="wrap-add-card">
            <button class="add-card-btn">+ Ïπ¥Îìú Ï∂îÍ∞Ä</button>
          </div>
        `;

        column.addEventListener("dragenter", () => {
          hoveredColumn = column;
        });

        const cardList = column.querySelector(".card-list");

        // Ïπ¥Îìú ÎìúÎ°≠ Ï†ÑÏö© ÏòÅÏó≠
        cardList.addEventListener("dragover", (e) => e.preventDefault());

        cardList.addEventListener("dragenter", (e) => {
          hoveredColumn = column;

          const targetCard = e.target.closest(".card");
          if (!targetCard || !cardList.contains(targetCard)) {
            if (!cardList.contains(guideLine)) {
              cardList.appendChild(guideLine); // Îπà Ïπ∏ÏóêÎèÑ
            }
            return;
          }

          hoveredCard = targetCard;

          // insertBefore ÌïòÍ∏∞ Ï†ÑÏóê Ï§ëÎ≥µ Ï†úÍ±∞
          if (guideLine.parentNode) {
            guideLine.parentNode.removeChild(guideLine);
          }

          // ÏúÑÏïÑÎûò ÏúÑÏπò ÌåêÎã®
          const box = targetCard.getBoundingClientRect();
          const isAbove = e.clientY < box.top + box.height / 2;

          if (isAbove) {
            cardList.insertBefore(guideLine, targetCard);
          } else {
            cardList.insertBefore(guideLine, targetCard.nextSibling);
          }
        });
        cardList.addEventListener("dragleave", (e) => {
          if (guideLine.parentNode && !cardList.contains(e.relatedTarget)) {
            guideLine.remove();
          }
        });

        cardList.addEventListener("drop", (e) => {
          if (!draggedCard) return;
          if (guideLine.parentNode) {
            cardList.insertBefore(draggedCard, guideLine);
            guideLine.remove();
          } else {
            cardList.appendChild(draggedCard);
          }
          const box = hoveredCard.getBoundingClientRect();
          const isAbove = e.clientY < box.top + box.height / 2;

          if (!hoveredCard || !cardList.contains(hoveredCard)) {
            cardList.appendChild(draggedCard);
          } else {
            const box = hoveredCard.getBoundingClientRect();
            const isAbove = e.clientY < box.top + box.height / 2;

            if (isAbove) {
              hoveredCard.parentElement.insertBefore(draggedCard, hoveredCard);
            } else {
              hoveredCard.parentElement.insertBefore(
                draggedCard,
                hoveredCard.nextSibling
              );
            }
          }
          draggedCard = null;
          hoveredCard = null;
        });

        // Ïπ¥Îìú Ï∂îÍ∞Ä Î≤ÑÌäº Í∏∞Îä•
        const addBtn = column.querySelector(".add-card-btn");
        addBtn.addEventListener("click", () => {
          const newCard = createCard();
          cardList.appendChild(newCard);
          saveBoardToStorage(); // Ïª¨Îüº Ï∂îÍ∞Ä Ïãú Ìò∏Ï∂ú
        });

        makeColDraggable(column);
        setupEditColumn(column);
        setupDeleteColumn(column);
        return column;
      }

      // Ïª¨Îüº Ï∂îÍ∞Ä Î≤ÑÌäº Í∏∞Îä•
      const addColumnBtn = document.querySelector(".add-column-btn");
      addColumnBtn.addEventListener("click", () => {
        const newColumn = createColumn(
          prompt("Ïª¨Îüº Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî") || "üÜï ÏÉà Ïª¨Îüº"
        );

        // Ïª¨Îüº Ï∂îÍ∞Ä Î≤ÑÌäº Î∞îÎ°ú ÏïûÏóê ÏÇΩÏûÖ
        const board = document.querySelector(".board");
        board.insertBefore(newColumn, addColumnBtn.parentElement);

        saveBoardToStorage(); // Ïª¨Îüº Ï∂îÍ∞Ä Ïãú Ìò∏Ï∂ú
      });

      const board = document.querySelector(".board");

      board.addEventListener("dragover", (e) => {
        e.preventDefault();
      });

      board.addEventListener("drop", (e) => {
        if (!draggedColumn || !hoveredColumn) return;

        const box = hoveredColumn.getBoundingClientRect();
        const isLeft = e.clientX < box.left + box.width / 2;

        if (isLeft) {
          board.insertBefore(draggedColumn, hoveredColumn);
        } else {
          board.insertBefore(draggedColumn, hoveredColumn.nextSibling);
        }

        hoveredColumn = null;
        draggedColumn = null;
      });

      // Î™®Îã¨ ÏöîÏÜå
      const modal = document.getElementById("detailModal");
      const closeBtn = modal.querySelector(".close-btn");
      const modalTitle = modal.querySelector(".modal-title");
      const modalEditor = modal.querySelector(".modal-editor");
      const modalMembers = modal.querySelector(".modal-members");

      // Ïπ¥Îìú ÌÅ¥Î¶≠ Ïãú Î™®Îã¨ Ïó¥Í∏∞
      document.addEventListener("click", (e) => {
        if (currentEditingCard) return;

        const card = e.target.closest(".card");
        if (!card) return;
        if (
          !e.target.classList.contains("edit-btn") &&
          !e.target.classList.contains("delete-btn")
        ) {
          if (card.querySelector("#edit-card-box")) return;

          const title = card.querySelector("h3")?.textContent || "";
          const members =
            card.querySelector(".card-members")?.textContent || "";
          const content = card.dataset.detail || "";

          modalTitle.textContent = title;
          modalTitle.setAttribute("contenteditable", "false");

          modalMembers.textContent = members;
          modalEditor.innerHTML = content;

          modal.currentCard = card;
          modal.style.display = "block";
        }
      });

      // Îã´Í∏∞ Î≤ÑÌäº
      closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
        saveModalChanges();
        resetModalFields(); // ‚úÖ Ï∂îÍ∞Ä
      });

      // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
      window.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
          saveModalChanges();
          resetModalFields(); // ‚úÖ Ï∂îÍ∞Ä
        }
      });

      // Ï†ÄÏû• Ìï®Ïàò
      function saveModalChanges() {
        if (!modal.currentCard) return;

        const cardId = modal.currentCard.dataset.id;
        const newTitle = modalTitle.textContent.trim();
        const newContent = modalEditor.innerHTML;
        const newMembers = modalMembers.textContent;

        // Ïπ¥Îìú DOM ÏóÖÎç∞Ïù¥Ìä∏
        modal.currentCard.querySelector("h3").textContent = newTitle;
        modal.currentCard.dataset.detail = newContent;
        modal.currentCard.querySelector(".card-members").textContent =
          newMembers;

        // ‚úÖ Ï†ÑÏ≤¥ Î≥¥Îìú ÏÉÅÌÉú Ï†ÄÏû•
        saveBoardToStorage();
      }

      const toggleBtn = document.getElementById("toggleEdit");
      const editor = document.querySelector(".modal-editor");
      let isEditing = false;
      let savedHtml = ""; // Ï†ÑÏó≠ÏúºÎ°ú Ï†ÄÏû•Ìï† Î≥ÄÏàò

      toggleBtn.addEventListener("click", () => {
        if (!isEditing) {
          savedHtml = editor.innerHTML; // ‚úÖ Ï†ÄÏû• ÏãúÏ†ê
          editor.textContent = savedHtml; // üëâ HTML ÌÉúÍ∑∏Î•º ÌÖçÏä§Ìä∏Î°ú Î≥¥Ïó¨Ï£ºÍ∏∞
          editor.setAttribute("contenteditable", "true");
          modalTitle.setAttribute("contenteditable", "true");

          toggleBtn.innerHTML = "‚úÖ Ï†ÄÏû•";
          toggleBtn.classList.add("save-card-btn");
          toggleBtn.classList.remove("edit-save-btn");
        } else {
          savedHtml = editor.textContent; // Ìé∏Ïßë Ï§ëÏù∏ ÌÖçÏä§Ìä∏ Ï†ÄÏû•
          editor.innerHTML = savedHtml; // ÌÖçÏä§Ìä∏Î•º HTMLÎ°ú Î†åÎçîÎßÅ
          editor.setAttribute("contenteditable", "false");
          modalTitle.setAttribute("contenteditable", "false");

          toggleBtn.innerHTML = "‚úèÔ∏è Ìé∏Ïßë";
          toggleBtn.classList.add("edit-save-btn");
          toggleBtn.classList.remove("save-card-btn");
        }
        isEditing = !isEditing;
      });

      function saveBoardToStorage() {
        const columns = Array.from(document.querySelectorAll(".column")).slice(
          0,
          -1
        );
        const boardData = columns.map((col) => {
          const title = col.querySelector("h2").textContent;
          const cards = Array.from(col.querySelectorAll(".card")).map(
            (card) => {
              return {
                id: card.dataset.id,
                title: card.querySelector("h3")?.textContent || "",
                members: card.querySelector(".card-members")?.textContent || "",
                detail: card.dataset.detail || "",
              };
            }
          );
          return { title, cards };
        });
        localStorage.setItem("kanbanBoard", JSON.stringify(boardData));
      }
      function resetModalFields() {
        modalTitle.textContent = "";
        modalTitle.setAttribute("contenteditable", "false");

        modalEditor.innerHTML = "";
        modalEditor.setAttribute("contenteditable", "false");

        modalMembers.textContent = "";
        toggleBtn.innerHTML = "‚úèÔ∏è Ìé∏Ïßë";
        toggleBtn.classList.remove("save-card-btn");
        toggleBtn.classList.add("edit-save-btn");
        isEditing = false;
      }

      function loadBoardFromStorage() {
        const data = JSON.parse(localStorage.getItem("kanbanBoard") || "[]");
        const board = document.querySelector(".board");
        data.forEach((col) => {
          const column = createColumn(col.title);
          const cardList = column.querySelector(".card-list");
          col.cards.forEach((card) => {
            const newCard = createCard(card);
            cardList.appendChild(newCard);
          });
          board.insertBefore(column, board.lastElementChild);
        });
      }
      window.addEventListener("DOMContentLoaded", loadBoardFromStorage);
    </script>
  </body>
</html>
