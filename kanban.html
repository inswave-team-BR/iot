<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì¹¸ë°˜ ë³´ë“œ</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }
      html::-webkit-scrollbar {
        display: none; /* for Chrome, Safari, and Opera */
      }
      body {
        margin: 0;
        background: #f4f6fa;
        padding: 20px;
        overflow-x: auto;
      }
      .board {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        scrollbar-width: none;
        min-width: max-content;
        margin-top: 60px;
      }
      #board-title {
        position: fixed; /* ê³ ì • */
        top: 0;
        left: 0;
        width: 100%;
        height: 60px;
        line-height: 60px; /* ì„¸ë¡œ ì •ë ¬ */
        background: #f4f6fa;
        z-index: 100;
        text-align: center;
        font-size: 24px;
        color: #2f3640;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* ì‚´ì§ ê·¸ë¦¼ì */
        margin: 0;
      }
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: fit-content; /* âœ… ì—¬ê¸°ë§Œ ìˆ˜ì •! */
      }

      .column {
        position: relative;
        z-index: 0;
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        width: 280px;
        flex-shrink: 0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }

      .column h2 {
        font-size: 18px;
        margin-bottom: 10px;
      }
      .card-title-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        outline: none;
      }
      .card-title-input:focus {
        border-color: #4b7bec;
      }

      .member-select {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background-color: #fff;
        font-size: 13px;
        margin-top: 8px;
      }

      .save-card-btn {
        margin-top: 12px;
        padding: 8px 14px;
        background-color: #4cd137;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        float: right;
        transition: background 0.2s;
      }
      .save-card-btn:hover {
        background-color: #44bd32;
      }
      .member-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 12px;
        padding-left: 0;
        list-style: none;
      }

      .member-list li {
        margin-right: 6px;
        cursor: pointer;
        position: relative;
        padding-left: 20px;
      }

      .member-list li::before {
        content: "ğŸ‘¥ ";
        position: absolute;
        left: 0;
      }
      .member-list li:hover {
        background-color: #ffdede;
        color: #c0392b;
        text-decoration: line-through;
      }
      .card-members::before,
      .modal-members::before {
        content: "ğŸ‘¥ ";
      }

      .card-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 10px;
        min-height: 30px; /* ğŸ‘ˆ ì´ê²ƒë§Œ ìˆìœ¼ë©´ ë¹ˆ ì»¬ëŸ¼ë„ ë“œë¡­ ê°€ëŠ¥í•´ì§ */
      }
      .card {
        background: #fafafa;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        z-index: 1;
      }
      .card.dragging {
        opacity: 0.5;
      }
      .add-card-btn,
      .add-column-btn {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
      }
      .delete-column,
      .edit-column {
        display: none;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
        padding: 3px;
        margin-top: 6px;
        float: right;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        background: #ffdddd;
      }
      .delete-column {
        padding-inline: 6px;
      }
      .col-header:hover .delete-column,
      .col-header:hover .edit-column {
        display: inline-block;
      }

      .column .edit-column {
        right: 36px;
        background: #e0f7ff;
      }
      .add-card-btn,
      .add-column-btn {
        background-color: #eef1f5;
        color: #333;
      }
      .add-card-btn:hover,
      .add-column-btn:hover {
        background-color: #d6e4f0;
      }
      .column-header {
        position: relative;
        padding-bottom: 10px;
      }

      .card .delete-btn,
      .card .edit-btn {
        display: none;
        position: absolute;
        top: 6px;
        right: 6px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        padding: 3px;
        background: #ffdddd;
      }
      .card .delete-btn {
        padding-inline: 6px;
      }

      .card .edit-btn {
        right: 30px;
        background: #e0f7ff;
      }

      .card:hover .delete-btn,
      .card:hover .edit-btn {
        display: inline-block;
      }
      /* ëª¨ë‹¬ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background: #fff;
        width: 500px;
        max-width: 90%;
        margin: 80px auto;
        padding: 15px;
        border-radius: 12px;
        position: relative;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 4px;
      }

      .close-btn {
        font-size: 20px;
        cursor: pointer;
        background: none;
        border: none;
        color: #999;
        transition: color 0.2s ease;
        padding: 4px 8px;
      }

      .close-btn:hover {
        color: #333;
      }

      .modal-title {
        width: 100%;
        font-size: 18px;
        padding: 8px;
        margin-bottom: 10px;
      }
      .modal-title[contenteditable="true"] {
        border: 1px solid #4b7bec;
        border-radius: 6px;
        padding: 8px;
        outline: none;
      }

      .modal-members {
        font-size: 14px;
        color: #444;
        margin-left: 10px;
        margin-bottom: 12px;
      }

      .modal-editor {
        min-height: 200px;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.5;
      }
      .edit-save-btn {
        background-color: #eef1f5;
        margin-top: 12px;
        padding: 8px 14px;
        color: black;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        float: right;
        transition: background 0.2s;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="board-title" contenteditable="false">ğŸ“Œ ì¹¸ë°˜ í”„ë¡œì íŠ¸ ë³´ë“œ ğŸ“Œ</h1>
      <div class="board">
        <div class="column">
          <button class="add-column-btn">+ ì»¬ëŸ¼ ì¶”ê°€</button>
        </div>
      </div>
    </div>
    <!-- ìƒì„¸ ëª¨ë‹¬ -->
    <div id="detailModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <button class="close-btn">&times;</button>
        </div>
        <div class="modal-title" contenteditable="false">ì œëª© ì…ë ¥</div>
        <div class="modal-members"></div>
        <div class="modal-editor" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
        <div style="margin-top: 10px; display: flex; justify-content: flex-end">
          <button id="toggleEdit" class="edit-save-btn">âœï¸ í¸ì§‘</button>
        </div>
      </div>
    </div>

    <script>
      let draggedCard = null;
      let draggedColumn = null;
      let hoveredCard = null;
      let hoveredColumn = null;
      let currentEditingCard = null;

      const boardTitle = document.getElementById("board-title");

      // í´ë¦­í•˜ë©´ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ
      boardTitle.addEventListener("click", () => {
        boardTitle.setAttribute("contenteditable", "true");
        boardTitle.focus();
      });

      // í¬ì»¤ìŠ¤ ë²—ì–´ë‚˜ë©´ ì €ì¥ + í¸ì§‘ ë¶ˆê°€í•˜ê²Œ
      boardTitle.addEventListener("blur", () => {
        boardTitle.setAttribute("contenteditable", "false");
        const title = boardTitle.textContent.trim() || "ğŸ“Œ ì¹¸ë°˜ í”„ë¡œì íŠ¸ ë³´ë“œ";
        boardTitle.textContent = title; // ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’

        // í•„ìš”í•˜ë©´ localStorageì— ì €ì¥
        localStorage.setItem("kanbanTitle", title);
      });

      // í˜ì´ì§€ ë¡œë“œì‹œ ì €ì¥ëœ ì œëª© ë¶ˆëŸ¬ì˜¤ê¸°
      window.addEventListener("DOMContentLoaded", () => {
        const savedTitle = localStorage.getItem("kanbanTitle");
        if (savedTitle) {
          boardTitle.textContent = savedTitle;
        }
      });

      // ì¹´ë“œ ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì—°ê²°
      function makeCardDraggable(card) {
        card.addEventListener("dragstart", () => {
          draggedCard = card;
          card.classList.add("dragging");
        });

        card.addEventListener("dragend", () => {
          card.classList.remove("dragging");
          hoveredCard = null;
          draggedCard = null;
        });
        card.addEventListener("dragenter", () => {
          hoveredCard = card;
        });
      }

      // ì»¬ëŸ¼ ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì—°ê²°
      function makeColDraggable(column) {
        column.addEventListener("dragstart", (e) => {
          if (e.target.closest(".card")) return;

          draggedColumn = column; // âœ… ì´ê²Œ ê¼­ ìˆì–´ì•¼ dropì—ì„œ ì‘ë™í•¨
          column.style.opacity = "0.5";

          const img = new Image();
          img.src = "";
          e.dataTransfer.setDragImage(img, 0, 0);
        });

        column.addEventListener("dragend", () => {
          column.style.opacity = "1";
          draggedColumn = null;
        });
      }

      // ì‚­ì œ ë²„íŠ¼ ì„¤ì •
      function setupDeleteButton(card) {
        const deleteBtn = card.querySelector(".delete-btn");
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (confirm("ì¹´ë“œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.")) {
            card.remove();
            saveBoardToStorage(); // ì‚­ì œ í›„ ì €ì¥
          }
        });
      }

      function setupEditColumn(column) {
        const editBtn = column.querySelector(".edit-column");
        const titleElem = column.querySelector("h2");

        editBtn.addEventListener("click", () => {
          const currentTitle = titleElem.textContent.trim();
          const input = document.createElement("input");
          input.type = "text";
          input.value = currentTitle;
          input.style.fontSize = "18px";
          input.style.width = "100%";
          input.style.marginBottom = "6px";
          input.style.marginTop = "25px";

          titleElem.replaceWith(input);
          input.focus();

          input.addEventListener("blur", () => {
            const newTitle = input.value.trim() || "ğŸ†• ìƒˆ ì»¬ëŸ¼";
            const newTitleElem = document.createElement("h2");
            newTitleElem.textContent = newTitle;
            input.replaceWith(newTitleElem);
            setupEditColumn(column);

            saveBoardToStorage(); // âœ… ì œëª© ë³€ê²½ í›„ ì €ì¥ ì¶”ê°€
          });

          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") input.blur();
          });
        });
      }

      // ì‚­ì œ ì»¬ëŸ¼ ì„¤ì •
      function setupDeleteColumn(column) {
        const deleteBtn = column.querySelector(".delete-column");
        deleteBtn.addEventListener("click", () => {
          if (window.confirm("ì»¬ëŸ¼ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.")) {
            column.remove();
            saveBoardToStorage(); // âœ… ì‚­ì œ í›„ ì €ì¥!
          }
        });
      }

      // ì¹´ë“œ ìƒì„± í•¨ìˆ˜
      function createCard(
        cardData = {
          title: "ğŸ†• ìƒˆ ì¹´ë“œ",
          id: Date.now().toString(),
          members: "",
          detail: "",
        }
      ) {
        const card = document.createElement("div");
        card.className = "card";
        card.draggable = true;
        card.style.position = "relative"; // ë²„íŠ¼ ìœ„ì¹˜ ìœ„í•´ í•„ìš”
        card.dataset.id = cardData.id;
        card.dataset.detail = cardData.detail;

        card.innerHTML = `
    <h3>${cardData.title}</h3>
      <div class = "card-members" style="font-size: 12px; color: #555; margin-top: 4px;">
         ${cardData.members}
      </div>
      <button class="edit-btn">âœï¸</button>
      <button class="delete-btn">X</button>
  `;

        makeCardDraggable(card);
        setupDeleteButton(card);
        setupEditButton(card);
        return card;
      }
      function switchToEditMode(card) {
        if (currentEditingCard && currentEditingCard !== card) {
          const prevCard = currentEditingCard;
          const titleInput = prevCard.querySelector(".card-title-input");
          const selectedList = prevCard.querySelectorAll(".member-list li");
          currentEditingCard = card;
          if (titleInput) {
            const title = titleInput.value.trim() || "ğŸ†• ìƒˆ ì¹´ë“œ";
            const members = Array.from(selectedList).map((li) =>
              li.textContent.trim()
            );

            prevCard.innerHTML = `
        <h3>${title}</h3>
        <div style="font-size: 12px; color: #555; margin-top: 4px;">
          ${members.join(", ")}
        </div>
        <button class="edit-btn">âœï¸</button>
        <button class="delete-btn">X</button>
      `;
            setupDeleteButton(prevCard);
            setupEditButton(prevCard);
            makeCardDraggable(prevCard);
          }
        }

        currentEditingCard = card;
        const members = ["ê¹€ì‹œì—°", "ì´ì¬ì„±", "ì´ì¬ì›", "í™©ìœ ì„"];

        const prevTitle =
          card.querySelector("h3")?.textContent.trim() || "ğŸ†• ìƒˆ ì¹´ë“œ";
        const prevMembersText = card.querySelector("div")?.textContent || "";
        const prevMembers = prevMembersText
          .replace("ğŸ‘¥", "")
          .split(",")
          .map((m) => m.trim())
          .filter(Boolean);

        const selectedMembers = [...prevMembers];

        // ì¹´ë“œ í¸ì§‘ UI êµ¬ì„± (liëŠ” ë¹„ì›Œë‘ê³  JSë¡œ ìƒì„±)
        card.innerHTML = `
    <div id="edit-card-box">
      <div>
        <input type="text" class="card-title-input" value="${prevTitle}" placeholder="${prevTitle}" />
      </div>
      <div style="margin-top:8px;">
        <select class="member-select">
          <option disabled selected>ğŸ‘¥ íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>
          ${members.map((m) => `<option value="${m}">${m}</option>`).join("")}
        </select>
      </div>
      <div class="member-list-wrapper" style="font-size: 14px; color: #555;">
        <ul class="member-list"></ul>
      </div>
      <button class="save-card-btn" style="margin-top:10px; padding:5px 10px;">âœ… í™•ì¸</button>
    </div>
  `;

        const titleInput = card.querySelector(".card-title-input");
        const select = card.querySelector(".member-select");
        const memberList = card.querySelector(".member-list");
        const saveBtn = card.querySelector(".save-card-btn");

        // ğŸ‘‡ í´ë¦­ ì‹œ ì‚­ì œ ê°€ëŠ¥í•œ <li> ìƒì„±
        function setupMemberClick(li, name) {
          li.addEventListener("click", (e) => {
            e.stopPropagation(); // ì €ì¥ ë°©ì§€
            selectedMembers.splice(selectedMembers.indexOf(name), 1);
            updateMemberList();
          });
        }

        function updateMemberList() {
          memberList.innerHTML = "";
          selectedMembers.forEach((name) => {
            const li = document.createElement("li");
            li.textContent = name;
            setupMemberClick(li, name);
            memberList.appendChild(li);
          });
        }

        select.addEventListener("change", () => {
          const value = select.value;
          if (!selectedMembers.includes(value)) {
            selectedMembers.push(value);
            updateMemberList();
          }
          select.selectedIndex = 0;
        });
        select.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault(); // ì…€ë ‰íŠ¸ ì—´ë¦¼ ë°©ì§€
            saveCard(); // ì €ì¥ ì‹¤í–‰
          }
        });

        updateMemberList(); // ì´ˆê¸° ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§

        // ì €ì¥ ì²˜ë¦¬
        function saveCard() {
          const title = titleInput.value.trim() || prevTitle;
          const detail = card.dataset.detail || ""; // ê¸°ì¡´ detail ìœ ì§€
          const rawMembers = selectedMembers.join(", ");

          card.innerHTML = `
    <h3>${title}</h3>
    <div class="card-members" style="font-size: 12px; color: #555; margin-top: 4px;">
      ${rawMembers}
    </div>
    <button class="edit-btn">âœï¸</button>
    <button class="delete-btn">X</button>
  `;

          card.dataset.detail = detail; // âœ… detailì€ ì—¬ì „íˆ DOMì— ë³´ê´€

          setupDeleteButton(card);
          setupEditButton(card);
          makeCardDraggable(card);
          currentEditingCard = null;
          // âœ… ì´ì œëŠ” ì—¬ê¸°ì„œë§Œ ì €ì¥
          saveBoardToStorage();
        }

        // í™•ì¸ ë²„íŠ¼
        saveBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          saveCard();
        });

        // ì œëª© ì…ë ¥ ì‹œ ì´ˆê¸°í™”
        /* let titleCleared = false;
        titleInput.addEventListener("focus", () => {
          if (!titleCleared) {
            titleInput.value = "";
            titleCleared = true;
          }
        });
*/
        titleInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault(); // ì¤„ë°”ê¿ˆ ë°©ì§€
            saveCard(); // ì €ì¥ ì‹¤í–‰
          }
        });

        // ì™¸ë¶€ í´ë¦­ ì‹œ ì €ì¥
        setTimeout(() => {
          document.addEventListener(
            "click",
            function handler(e) {
              if (!card.contains(e.target)) {
                saveCard();
                document.removeEventListener("click", handler);
              }
            },
            { once: true }
          );
        }, 0);

        titleInput.focus();
      }

      function setupEditButton(card) {
        const editBtn = card.querySelector(".edit-btn");
        editBtn.addEventListener("click", (e) => {
          e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
          switchToEditMode(card);
        });
      }
      // ê°€ì´ë“œ ë¼ì¸ ìƒì„±í•¨ìˆ˜
      function createGuideLine() {
        const guideLine = document.createElement("div");
        guideLine.className = "guide-line";
        guideLine.style.height = "10px";
        guideLine.style.background = "#cccccc";
        guideLine.style.margin = "4px 0";
        guideLine.style.borderRadius = "3px";
        return guideLine;
      }
      // ì»¬ëŸ¼ ìƒì„± í•¨ìˆ˜
      function createColumn(title = "ğŸ†• ìƒˆ ì»¬ëŸ¼") {
        const column = document.createElement("div");
        const guideLine = createGuideLine();
        column.className = "column";
        column.draggable = true;
        column.innerHTML = `<div class = "col-header">
          <button class="edit-column">âœï¸</button>
          <button class="delete-column">X</button>
            <h2>${title}</h2>
          </div>
          <div class="card-list"></div>
          <div class="wrap-add-card">
            <button class="add-card-btn">+ ì¹´ë“œ ì¶”ê°€</button>
          </div>
        `;

        column.addEventListener("dragenter", () => {
          hoveredColumn = column;
        });

        const cardList = column.querySelector(".card-list");

        // ì¹´ë“œ ë“œë¡­ ì „ìš© ì˜ì—­
        cardList.addEventListener("dragover", (e) => e.preventDefault());

        cardList.addEventListener("dragenter", (e) => {
          hoveredColumn = column;

          const targetCard = e.target.closest(".card");
          if (!targetCard || !cardList.contains(targetCard)) {
            if (!cardList.contains(guideLine)) {
              cardList.appendChild(guideLine); // ë¹ˆ ì¹¸ì—ë„
            }
            return;
          }

          hoveredCard = targetCard;

          // insertBefore í•˜ê¸° ì „ì— ì¤‘ë³µ ì œê±°
          if (guideLine.parentNode) {
            guideLine.parentNode.removeChild(guideLine);
          }

          // ìœ„ì•„ë˜ ìœ„ì¹˜ íŒë‹¨
          const box = targetCard.getBoundingClientRect();
          const isAbove = e.clientY < box.top + box.height / 2;

          if (isAbove) {
            cardList.insertBefore(guideLine, targetCard);
          } else {
            cardList.insertBefore(guideLine, targetCard.nextSibling);
          }
        });
        cardList.addEventListener("dragleave", (e) => {
          if (guideLine.parentNode && !cardList.contains(e.relatedTarget)) {
            guideLine.remove();
          }
        });

        cardList.addEventListener("drop", (e) => {
          if (!draggedCard) return;
          if (guideLine.parentNode) {
            cardList.insertBefore(draggedCard, guideLine);
            guideLine.remove();
          } else {
            cardList.appendChild(draggedCard);
          }
          const box = hoveredCard.getBoundingClientRect();
          const isAbove = e.clientY < box.top + box.height / 2;

          if (!hoveredCard || !cardList.contains(hoveredCard)) {
            cardList.appendChild(draggedCard);
          } else {
            const box = hoveredCard.getBoundingClientRect();
            const isAbove = e.clientY < box.top + box.height / 2;

            if (isAbove) {
              hoveredCard.parentElement.insertBefore(draggedCard, hoveredCard);
            } else {
              hoveredCard.parentElement.insertBefore(
                draggedCard,
                hoveredCard.nextSibling
              );
            }
          }
          draggedCard = null;
          hoveredCard = null;
        });

        // ì¹´ë“œ ì¶”ê°€ ë²„íŠ¼ ê¸°ëŠ¥
        const addBtn = column.querySelector(".add-card-btn");
        addBtn.addEventListener("click", () => {
          const newCard = createCard();
          cardList.appendChild(newCard);
          saveBoardToStorage(); // ì»¬ëŸ¼ ì¶”ê°€ ì‹œ í˜¸ì¶œ
        });

        makeColDraggable(column);
        setupEditColumn(column);
        setupDeleteColumn(column);
        return column;
      }

      // ì»¬ëŸ¼ ì¶”ê°€ ë²„íŠ¼ ê¸°ëŠ¥
      const addColumnBtn = document.querySelector(".add-column-btn");
      addColumnBtn.addEventListener("click", () => {
        const newColumn = createColumn(
          prompt("ì»¬ëŸ¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”") || "ğŸ†• ìƒˆ ì»¬ëŸ¼"
        );

        // ì»¬ëŸ¼ ì¶”ê°€ ë²„íŠ¼ ë°”ë¡œ ì•ì— ì‚½ì…
        const board = document.querySelector(".board");
        board.insertBefore(newColumn, addColumnBtn.parentElement);

        saveBoardToStorage(); // ì»¬ëŸ¼ ì¶”ê°€ ì‹œ í˜¸ì¶œ
      });

      const board = document.querySelector(".board");

      board.addEventListener("dragover", (e) => {
        e.preventDefault();
      });

      board.addEventListener("drop", (e) => {
        if (!draggedColumn || !hoveredColumn) return;

        const box = hoveredColumn.getBoundingClientRect();
        const isLeft = e.clientX < box.left + box.width / 2;

        if (isLeft) {
          board.insertBefore(draggedColumn, hoveredColumn);
        } else {
          board.insertBefore(draggedColumn, hoveredColumn.nextSibling);
        }

        hoveredColumn = null;
        draggedColumn = null;
      });

      // ëª¨ë‹¬ ìš”ì†Œ
      const modal = document.getElementById("detailModal");
      const closeBtn = modal.querySelector(".close-btn");
      const modalTitle = modal.querySelector(".modal-title");
      const modalEditor = modal.querySelector(".modal-editor");
      const modalMembers = modal.querySelector(".modal-members");

      // ì¹´ë“œ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
      document.addEventListener("click", (e) => {
        if (currentEditingCard) return;

        const card = e.target.closest(".card");
        if (!card) return;
        if (
          !e.target.classList.contains("edit-btn") &&
          !e.target.classList.contains("delete-btn")
        ) {
          if (card.querySelector("#edit-card-box")) return;

          const title = card.querySelector("h3")?.textContent || "";
          const members =
            card.querySelector(".card-members")?.textContent || "";
          const content = card.dataset.detail || "";

          modalTitle.textContent = title;
          modalTitle.setAttribute("contenteditable", "false");

          modalMembers.textContent = members;
          modalEditor.innerHTML = content;

          modal.currentCard = card;
          modal.style.display = "block";
        }
      });

      // ë‹«ê¸° ë²„íŠ¼
      closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
        saveModalChanges();
        resetModalFields(); // âœ… ì¶”ê°€
      });

      // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      window.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
          saveModalChanges();
          resetModalFields(); // âœ… ì¶”ê°€
        }
      });

      // ì €ì¥ í•¨ìˆ˜
      function saveModalChanges() {
        if (!modal.currentCard) return;

        const cardId = modal.currentCard.dataset.id;
        const newTitle = modalTitle.textContent.trim();
        const newContent = modalEditor.innerHTML;
        const newMembers = modalMembers.textContent;

        // ì¹´ë“œ DOM ì—…ë°ì´íŠ¸
        modal.currentCard.querySelector("h3").textContent = newTitle;
        modal.currentCard.dataset.detail = newContent;
        modal.currentCard.querySelector(".card-members").textContent =
          newMembers;

        // âœ… ì „ì²´ ë³´ë“œ ìƒíƒœ ì €ì¥
        saveBoardToStorage();
      }

      const toggleBtn = document.getElementById("toggleEdit");
      const editor = document.querySelector(".modal-editor");
      let isEditing = false;
      let savedHtml = ""; // ì „ì—­ìœ¼ë¡œ ì €ì¥í•  ë³€ìˆ˜

      toggleBtn.addEventListener("click", () => {
        if (!isEditing) {
          savedHtml = editor.innerHTML; // âœ… ì €ì¥ ì‹œì 
          editor.textContent = savedHtml; // ğŸ‘‰ HTML íƒœê·¸ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³´ì—¬ì£¼ê¸°
          editor.setAttribute("contenteditable", "true");
          modalTitle.setAttribute("contenteditable", "true");

          toggleBtn.innerHTML = "âœ… ì €ì¥";
          toggleBtn.classList.add("save-card-btn");
          toggleBtn.classList.remove("edit-save-btn");
        } else {
          savedHtml = editor.textContent; // í¸ì§‘ ì¤‘ì¸ í…ìŠ¤íŠ¸ ì €ì¥
          editor.innerHTML = savedHtml; // í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë Œë”ë§
          editor.setAttribute("contenteditable", "false");
          modalTitle.setAttribute("contenteditable", "false");

          toggleBtn.innerHTML = "âœï¸ í¸ì§‘";
          toggleBtn.classList.add("edit-save-btn");
          toggleBtn.classList.remove("save-card-btn");
        }
        isEditing = !isEditing;
      });

      function saveBoardToStorage() {
        const columns = Array.from(document.querySelectorAll(".column")).slice(
          0,
          -1
        );
        const boardData = columns.map((col) => {
          const title = col.querySelector("h2").textContent;
          const cards = Array.from(col.querySelectorAll(".card")).map(
            (card) => {
              return {
                id: card.dataset.id,
                title: card.querySelector("h3")?.textContent || "",
                members: card.querySelector(".card-members")?.textContent || "",
                detail: card.dataset.detail || "",
              };
            }
          );
          return { title, cards };
        });
        localStorage.setItem("kanbanBoard", JSON.stringify(boardData));
      }
      function resetModalFields() {
        modalTitle.textContent = "";
        modalTitle.setAttribute("contenteditable", "false");

        modalEditor.innerHTML = "";
        modalEditor.setAttribute("contenteditable", "false");

        modalMembers.textContent = "";
        toggleBtn.innerHTML = "âœï¸ í¸ì§‘";
        toggleBtn.classList.remove("save-card-btn");
        toggleBtn.classList.add("edit-save-btn");
        isEditing = false;
      }

      function loadBoardFromStorage() {
        const data = JSON.parse(localStorage.getItem("kanbanBoard") || "[]");
        const board = document.querySelector(".board");
        data.forEach((col) => {
          const column = createColumn(col.title);
          const cardList = column.querySelector(".card-list");
          col.cards.forEach((card) => {
            const newCard = createCard(card);
            cardList.appendChild(newCard);
          });
          board.insertBefore(column, board.lastElementChild);
        });
      }
      window.addEventListener("DOMContentLoaded", loadBoardFromStorage);
    </script>
  </body>
</html>
